<div class="page-wrapper">
    <div class="work-card">
        <p-toast></p-toast>

        <div class="profile-header mb-4">
            <div class="header-left">
                <h2 class="page-title">Profile</h2>
            </div>
            <div class="header-actions">
                <p-button label="Update Password" icon="pi pi-key" severity="warn" (onClick)="showDialog()"></p-button>
                <p-button label="Logs" *ngIf="isAdmin" icon="pi pi-list" severity="secondary" (onClick)="loadLogs()"></p-button>
                <p-button *ngIf="isAdmin" label="Refresh List" icon="pi pi-sync" [text]="true" (onClick)="loadUsers()"></p-button>
            </div>
        </div>

        <div *ngIf="isAdmin">
            <h3 class="mb-3 text-700">USER MANAGEMENT</h3>
            <p-table [value]="users" [rows]="10" [paginator]="true" responsiveLayout="scroll" [loading]="isLoadingTable"
                styleClass="p-datatable-striped">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Email</th>
                        <th>User ID</th>
                        <th>Current Role</th>
                        <th style="width: 250px">Manage Role</th>
                        <th style="width: 100px">Actions</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-user>
                    <tr>
                        <td><span class="font-bold">{{ user.email }}</span></td>
                        <td><code class="text-xs">{{ user.id }}</code></td>
                        <td>
                            <p-tag [value]="user.role | uppercase" [severity]="getRoleSeverity(user.role)">
                            </p-tag>
                        </td>
                        <td>
                            <p-select [options]="roleOptions" [(ngModel)]="user.role" (onChange)="onRoleChange(user)"
                                appendTo="body" styleClass="w-full p-inputtext-sm">
                            </p-select>
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <p-button icon="pi pi-trash" (onClick)="onDeleteUser(user)" severity="danger"
                                    [rounded]="true" [text]="true" title="Delete User"></p-button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="5" class="text-center p-4">No users found.</td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>

<p-dialog header="Update Password" [(visible)]="displayPasswordDialog" [modal]="true" [style]="{ width: '450px' }"
    [draggable]="false" [resizable]="false">
    <div class="flex flex-column gap-4 mt-2">

        <div class="flex flex-column gap-2">
            <label for="current" class="font-medium text-900">Current Password</label>
            <p-password id="current" [(ngModel)]="passwordData.currentPassword" [feedback]="false" [toggleMask]="true"
                styleClass="w-full" inputStyleClass="w-full p-inputtext-md">
            </p-password>
        </div>

        <div class="flex flex-column gap-2" style="margin-top: 10px;">
            <label for="new" class="font-medium text-900">New Password</label>
            <p-password id="new" [(ngModel)]="passwordData.newPassword" [toggleMask]="true" styleClass="w-full"
                inputStyleClass="w-full p-inputtext-md">
            </p-password>
        </div>

        <div class="flex flex-column gap-2" style="margin-top: 10px;">
            <label for="confirm" class="font-medium text-900">Confirm New Password</label>
            <p-password id="confirm" [(ngModel)]="passwordData.confirmPassword" [feedback]="false" [toggleMask]="true"
                styleClass="w-full" inputStyleClass="w-full p-inputtext-md">
            </p-password>
        </div>

    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-content-end gap-2 mt-3">
            <p-button label="Cancel" icon="pi pi-times" [text]="true" severity="secondary"
                (onClick)="displayPasswordDialog = false"></p-button>
            <p-button label="Update" icon="pi pi-check" severity="success" [loading]="isLoading"
                (onClick)="onUpdatePassword()"></p-button>
        </div>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="displayLogsDialog" header="System Logs" [modal]="true" [draggable]="false"
    [resizable]="false" [style]="{width: '90vw', height: '90vh'}" [breakpoints]="{'960px': '95vw', '640px': '100vw'}"
    appendTo="body" styleClass="custom-dialog" *ngIf="isAdmin">

    <div class="flex gap-2 mb-4">
        <p-button label="Sync Logs" icon="pi pi-sync" (onClick)="syncLogs()"></p-button>
        <p-button label="Clear Logs" icon="pi pi-trash" severity="danger" (onClick)="clearLogs()"></p-button>
    </div>

    <p-table [value]="allLogs" [rows]="20" [paginator]="true" responsiveLayout="scroll"
        styleClass="p-datatable-striped">
        <ng-template pTemplate="header">
            <tr>
                <th>Timestamp</th>
                <th>Type</th>
                <th>Service</th>
                <th>URL</th>
                <th>Status Code</th>
                <th>Correlation ID</th>
                <th>Message</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-log>
            <tr>
                <td>{{ log.timestamp | date:'yyyy-MM-dd HH:mm:ss' }}</td>
                <td>
                    <p-tag [value]="log.logType || log.level" [severity]="(log.logType === 'ERROR' || log.level === 'ERROR') ? 'danger' : ((log.logType === 'WARN' || log.level === 'WARN') ? 'warn' : 'info')">
                    </p-tag>
                </td>
                <td>{{ log.serviceName || log.service }}</td>
                <td><code>{{ log.url }}</code></td>
                <td>
                    <p-tag *ngIf="log.statusCode" [value]="log.statusCode"
                        [severity]="log.statusCode >= 200 && log.statusCode < 300 ? 'success' : (log.statusCode >= 400 ? 'danger' : 'warn')">
                    </p-tag>
                    <span *ngIf="!log.statusCode">-</span>
                </td>
                <td><code class="text-xs">{{ log.correlationId }}</code></td>
                <td>{{ log.message }}</td>
            </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="7" class="text-center p-4">
                    <p>No logs available.</p>
                </td>
            </tr>
        </ng-template>
    </p-table>

    <ng-template pTemplate="footer">
        <p-button label="Close" icon="pi pi-times" [text]="true" severity="secondary"
            (onClick)="hideLogsDialog()"></p-button>
    </ng-template>
</p-dialog>