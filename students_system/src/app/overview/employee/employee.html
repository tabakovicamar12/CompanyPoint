<div class="page-wrapper">
    <div class="work-card">
        <p-toast></p-toast>

        <ng-container *ngIf="isAdmin">
            <p-card>
                <ng-template pTemplate="header">
                    <div style="background-color: #f8f9fa;">
                        <h3 style="padding: 20px;font-weight: bold;">All Employees</h3>
                    </div>
                </ng-template>

                <div class="flex flex-wrap gap-4 justify-content-start mb-4">
                    <div class="field flex flex-column align-items-start" style="width: 280px;">
                        <label for="search" class="font-bold text-sm text-700 mb-2">Search</label>
                        <input id="search" pInputText [(ngModel)]="searchText" type="text" class="w-full"
                            placeholder="Search by name or email" (keyup)="applyFilters()" />
                    </div>

                    <div class="field flex flex-column align-items-start" style="width: 280px;">
                        <label for="dept" class="font-bold text-sm text-700 mb-2">Department</label>
                        <p-select id="dept" [options]="departments" [(ngModel)]="selectedDepartment" optionLabel="label"
                            optionValue="value" placeholder="Select Department" styleClass="w-full dialog-input"
                            (onChange)="applyFilters()" appendTo="body">
                        </p-select>
                    </div>

                    <div class="field flex flex-column align-items-start" style="width: 280px;">
                        <label for="status" class="font-bold text-sm text-700 mb-2">Status</label>
                        <p-select id="status" [options]="statusOptions" [(ngModel)]="selectedStatus" optionLabel="label"
                            optionValue="value" placeholder="Select Status" styleClass="w-full dialog-input"
                            (onChange)="applyFilters()" appendTo="body">
                        </p-select>
                    </div>
                </div>

                <div class="flex gap-2 mb-4" style="margin-top: 10px">
                    <p-button label="Add Employee" icon="pi pi-plus" (onClick)="showAddDialog()"></p-button>
                    <p-button label="Bulk Import" icon="pi pi-upload" severity="info" (onClick)="showBulkImportDialog()"></p-button>
                    <p-button label="System Logs" icon="pi pi-list" severity="secondary" (onClick)="loadLogs()"></p-button>
                    <p-button label="Reset Filters" icon="pi pi-refresh" severity="secondary" (onClick)="resetFilters()"></p-button>
                    <p-button label="Refresh" icon="pi pi-sync" severity="info" (onClick)="refreshData()"></p-button>
                </div>

                <p-table [value]="filteredEmployees" [rows]="15" [paginator]="true" responsiveLayout="scroll"
                    [loading]="isLoading" styleClass="p-datatable-striped">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Email</th>
                            <th>Position</th>
                            <th>Department</th>
                            <th>Status</th>
                            <th>Hire Date</th>
                            <th style="width: 120px">Actions</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-employee>
                        <tr>
                            <td>{{ employee.firstName }}</td>
                            <td>{{ employee.lastName }}</td>
                            <td>{{ employee.email }}</td>
                            <td>{{ employee.position }}</td>
                            <td>{{ employee.department }}</td>
                            <td>
                                <span class="font-semibold" 
                                    [ngClass]="{'text-green-600': employee.status === 'active', 
                                               'text-red-600': employee.status === 'inactive',
                                               'text-yellow-600': employee.status === 'on_leave'}">
                                    {{ employee.status | uppercase }}
                                </span>
                            </td>
                            <td>{{ employee.hireDate | date:'yyyy-MM-dd' }}</td>
                            <td>
                                <div class="flex gap-2">
                                    <p-button icon="pi pi-pencil" severity="warn" [rounded]="true" [text]="true"
                                        [title]="'Edit'" (onClick)="editEmployee(employee)"></p-button>
                                    <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [text]="true"
                                        [title]="'Delete'" (onClick)="deleteEmployee(employee.id, employee.firstName + ' ' + employee.lastName)"></p-button>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="8" class="text-center p-4">
                                <p>No employees found. Try adjusting your filters.</p>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-card>
        </ng-container>

        <ng-container *ngIf="isUser">
            <div class="flex align-items-center mb-1">
                <h2 style="margin-right: 10px;">EMPLOYEE DIRECTORY</h2>
            </div>

            <p-table [value]="allEmployees" [rows]="10" [paginator]="true" responsiveLayout="scroll"
                [loading]="isLoading" styleClass="p-datatable-striped">
                <ng-template pTemplate="header">
                    <tr>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Email</th>
                        <th>Position</th>
                        <th>Department</th>
                        <th>Status</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-employee>
                    <tr>
                        <td>{{ employee.firstName }}</td>
                        <td>{{ employee.lastName }}</td>
                        <td>{{ employee.email }}</td>
                        <td>{{ employee.position }}</td>
                        <td>{{ employee.department }}</td>
                        <td>
                            <span class="font-semibold" 
                                [ngClass]="{'text-green-600': employee.status === 'active', 
                                           'text-red-600': employee.status === 'inactive',
                                           'text-yellow-600': employee.status === 'on_leave'}">
                                {{ employee.status | uppercase }}
                            </span>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="6" class="text-center p-4">
                            <p>No employees found.</p>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </ng-container>
    </div>

    <p-dialog [(visible)]="displayDialog" [header]="isEdit ? 'Edit Employee' : 'Add Employee'" [modal]="true"
        [draggable]="false" [resizable]="false" [style]="{width: '500px'}"
        [breakpoints]="{'960px': '75vw', '640px': '90vw'}" appendTo="body" styleClass="custom-dialog">

        <div class="dialog-content">
            <div class="dialog-field">
                <label for="firstName" class="font-bold text-sm text-700">
                    First Name <span class="text-red-500">*</span>
                </label>
                <input pInputText id="firstName" [(ngModel)]="currentEmployee.firstName" type="text" class="w-full dialog-input"
                    placeholder="Enter first name" />
            </div>

            <div class="dialog-field">
                <label for="lastName" class="font-bold text-sm text-700">
                    Last Name <span class="text-red-500">*</span>
                </label>
                <input pInputText id="lastName" [(ngModel)]="currentEmployee.lastName" type="text" class="w-full dialog-input"
                    placeholder="Enter last name" />
            </div>

            <div class="dialog-field">
                <label for="email" class="font-bold text-sm text-700">
                    Email <span class="text-red-500">*</span>
                </label>
                <input pInputText id="email" [(ngModel)]="currentEmployee.email" type="email" class="w-full dialog-input"
                    placeholder="Enter email" />
            </div>

            <div class="dialog-field">
                <label for="position" class="font-bold text-sm text-700">
                    Position <span class="text-red-500">*</span>
                </label>
                <input pInputText id="position" [(ngModel)]="currentEmployee.position" type="text" class="w-full dialog-input"
                    placeholder="Enter position" />
            </div>

            <div class="dialog-field">
                <label for="department" class="font-bold text-sm text-700">
                    Department <span class="text-red-500">*</span>
                </label>
                <input pInputText id="department" [(ngModel)]="currentEmployee.department" type="text" class="w-full dialog-input"
                    placeholder="Enter department" />
            </div>

            <div class="dialog-field">
                <label for="status" class="font-bold text-sm text-700">
                    Status <span class="text-red-500">*</span>
                </label>
                <p-select id="status" [options]="statusOptions" [(ngModel)]="currentEmployee.status" optionLabel="label"
                    optionValue="value" placeholder="Select Status" styleClass="w-full dialog-input" appendTo="body">
                </p-select>
            </div>

            <div class="dialog-field">
                <label for="hireDate" class="font-bold text-sm text-700">
                    Hire Date <span class="text-red-500">*</span>
                </label>
                <input pInputText id="hireDate" [(ngModel)]="currentEmployee.hireDate" type="date" class="w-full dialog-input" />
            </div>
        </div>

        <ng-template pTemplate="footer">
            <div class="flex justify-content-end gap-2 pt-3 border-top-1 surface-border">
                <p-button label="Cancel" icon="pi pi-times" [text]="true" severity="secondary"
                    (onClick)="hideDialog()"></p-button>
                <p-button [label]="isEdit ? 'Update' : 'Create'" icon="pi pi-check" (onClick)="saveEmployee()"
                    styleClass="px-4"></p-button>
            </div>
        </ng-template>
    </p-dialog>

    <p-dialog [(visible)]="displayBulkDialog" header="Bulk Import Employees" [modal]="true" [draggable]="false"
        [resizable]="false" [style]="{width: '600px'}" [breakpoints]="{'960px': '75vw', '640px': '90vw'}"
        appendTo="body" styleClass="custom-dialog">

        <div class="dialog-content">
            <p style="margin-bottom: 1rem; font-size: 0.9rem; color: #666;">
                Paste employee data in TSV format (Tab-separated):
                <br/>First Name &lt;TAB&gt; Last Name &lt;TAB&gt; Email &lt;TAB&gt; Position &lt;TAB&gt; Department &lt;TAB&gt; Status
            </p>
            <textarea pInputTextarea [(ngModel)]="bulkImportData" rows="10" class="w-full"
                placeholder="John&#10;Doe&#10;john.doe@company.com&#10;Developer&#10;IT&#10;active&#10;&#10;Jane&#10;Smith&#10;jane.smith@company.com&#10;Manager&#10;HR&#10;active">
            </textarea>
        </div>

        <ng-template pTemplate="footer">
            <div class="flex justify-content-end gap-2 pt-3 border-top-1 surface-border">
                <p-button label="Cancel" icon="pi pi-times" [text]="true" severity="secondary"
                    (onClick)="hideBulkDialog()"></p-button>
                <p-button label="Import" icon="pi pi-upload" (onClick)="bulkImport()"
                    styleClass="px-4"></p-button>
            </div>
        </ng-template>
    </p-dialog>

    <p-dialog [(visible)]="displayLogsDialog" header="System Logs" [modal]="true" [draggable]="false" [resizable]="false"
        [style]="{width: '90vw', height: '90vh'}" [breakpoints]="{'960px': '95vw', '640px': '100vw'}" appendTo="body"
        styleClass="custom-dialog">

        <div class="flex gap-2 mb-4">
            <p-button label="Clear Logs" icon="pi pi-trash" severity="danger" (onClick)="clearLogs()"></p-button>
        </div>

        <p-table [value]="allLogs" [rows]="20" [paginator]="true" responsiveLayout="scroll"
            styleClass="p-datatable-striped">
            <ng-template pTemplate="header">
                <tr>
                    <th>Timestamp</th>
                    <th>Level</th>
                    <th>Service</th>
                    <th>URL</th>
                    <th>Status Code</th>
                    <th>Correlation ID</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-log>
                <tr>
                    <td>{{ log.timestamp | date:'yyyy-MM-dd HH:mm:ss' }}</td>
                    <td>
                        <p-tag [value]="log.level" [severity]="log.level === 'ERROR' ? 'danger' : (log.level === 'WARN' ? 'warn' : 'info')">
                        </p-tag>
                    </td>
                    <td>{{ log.service }}</td>
                    <td><code>{{ log.url }}</code></td>
                    <td>
                        <p-tag [value]="log.statusCode"
                            [severity]="log.statusCode >= 200 && log.statusCode < 300 ? 'success' : (log.statusCode >= 400 ? 'danger' : 'warn')">
                        </p-tag>
                    </td>
                    <td><code class="text-xs">{{ log.correlationId }}</code></td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6" class="text-center p-4">
                        <p>No logs available.</p>
                    </td>
                </tr>
            </ng-template>
        </p-table>

        <ng-template pTemplate="footer">
            <p-button label="Close" icon="pi pi-times" [text]="true" severity="secondary"
                (onClick)="hideLogsDialog()"></p-button>
        </ng-template>
    </p-dialog>
</div>

<router-outlet></router-outlet>
