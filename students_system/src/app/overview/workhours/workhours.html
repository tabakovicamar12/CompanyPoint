<div class="page-wrapper">
    <div class="work-card">
        <p-toast></p-toast>
        <ng-container *ngIf="isUser">
            <div class="flex align-items-center mb-1">
                <h2 style="margin-right: 10px;">WORKHOURS</h2>
                <p-button label="Log Work Hours" icon="pi pi-plus" (onClick)="showAddDialog()"></p-button>
            </div>

            <div class="mb-4">
                <input pInputText [(ngModel)]="tableSearchText" (ngModelChange)="onTableSearchChange()" 
                    type="text" placeholder="Search by date or description..." class="w-full" 
                    style="padding: 0.75rem; border: 1px solid #ced4da; border-radius: 6px;" />
            </div>

            <p-table [value]="filteredUserEntries" [rows]="10" [paginator]="true" responsiveLayout="scroll"
                [loading]="isLoading" styleClass="p-datatable-striped">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Date</th>
                        <th>Hours</th>
                        <th>Description</th>
                        <th style="width: 120px">Actions</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-entry>
                    <tr>
                        <td>{{ entry.work_date | date:'yyyy-MM-dd' }}</td>
                        <td>{{ entry.hours }}h</td>
                        <td>{{ entry.description || '-' }}</td>
                        <td>
                            <div class="flex gap-2">
                                <p-button icon="pi pi-pencil" severity="warn" [rounded]="true" [text]="true"
                                    [title]="'Edit'" (onClick)="editWorkEntry(entry)"></p-button>
                                <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [text]="true"
                                    [title]="'Delete'" (onClick)="deleteWorkEntry(entry.id)"></p-button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="4" class="text-center p-4">
                            <p>No work hours logged yet. Start by clicking "Log Work Hours".</p>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </ng-container>

        <ng-container *ngIf="isAdmin">
            <p-card>
                <ng-template pTemplate="header">
                    <div style="background-color: #f8f9fa;">
                        <h3 style="padding: 20px;">Employee Work Hours</h3>
                    </div>
                </ng-template>

                <div class="grid flex flex-wrap gap-4 justify-content-start mb-4">

                    <div class="field flex flex-column align-items-start md:w-15rem">
                        <label for="empId" class="font-bold text-sm text-700 mb-2">Employee Name</label>
                        <input id="empId" pInputText [(ngModel)]="selectedEmployeeName" (ngModelChange)="onEmployeeNameChange()" 
                            type="text" class="w-full" placeholder="Full name" />
                    </div>

                    <div class="field flex flex-column align-items-start md:w-15rem">
                        <label for="tableSearch" class="font-bold text-sm text-700 mb-2">Search</label>
                        <input id="tableSearch" pInputText [(ngModel)]="tableSearchText" (ngModelChange)="onTableSearchChange()" 
                            type="text" class="w-full" placeholder="Date, hours, description..." />
                    </div>

                    <div class="field flex flex-column align-items-start md:w-15rem">
                        <label for="fromDate" class="font-bold text-sm text-700 mb-2">From Date</label>
                        <p-datepicker id="fromDate" [(ngModel)]="filterFromDate" dateFormat="yy-mm-dd" [showIcon]="true"
                            styleClass="w-full" inputStyleClass="w-full" placeholder="Select start date">
                        </p-datepicker>
                    </div>

                    <div class="field flex flex-column align-items-start md:w-15rem">
                        <label for="toDate" class="font-bold text-sm text-700 mb-2">To Date</label>
                        <p-datepicker id="toDate" [(ngModel)]="filterToDate" dateFormat="yy-mm-dd" [showIcon]="true"
                            styleClass="w-full" inputStyleClass="w-full" placeholder="Select end date">
                        </p-datepicker>
                    </div>

                </div>

                <div class="flex gap-2 mb-4" style="margin-top: 10px">
                    <p-button label="Add Work Hours" icon="pi pi-plus" (onClick)="showAddDialog()"></p-button>
                    <p-button label="Apply Filters" icon="pi pi-filter" (onClick)="applyAdminFilters()"></p-button>
                    <p-button label="Reset" icon="pi pi-refresh" severity="secondary"
                        (onClick)="resetAdminFilters()"></p-button>
                    <p-button label="Refresh" icon="pi pi-sync" severity="info"
                        (onClick)="refreshAdminData()"></p-button>
                </div>

                <p-table [value]="filteredAllEntries" [rows]="15" [paginator]="true" responsiveLayout="scroll"
                    [loading]="isLoading" styleClass="p-datatable-striped">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Employee ID</th>
                            <th>Employee Name</th>
                            <th>Date</th>
                            <th>Hours</th>
                            <th>Description</th>
                            <th style="width: 100px">Actions</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-entry>
                        <tr>
                            <td>{{ entry.employee_id || entry.employeeId || '-' }}</td>
                            <td>{{ entry.employee_name || entry.employeeName || '-' }}</td>
                            <td>{{ entry.work_date | date:'yyyy-MM-dd' }}</td>
                            <td>{{ entry.hours }}h</td>
                            <td>{{ entry.description || '-' }}</td>
                            <td style="display: flex;">
                                <p-button icon="pi pi-pencil" severity="warn" [rounded]="true" [text]="true"
                                    [title]="'Edit'" (onClick)="editWorkEntryAdmin(entry)"></p-button>
                                <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [text]="true"
                                    [title]="'Delete'"
                                    (onClick)="deleteEmployeeEntry(entry.id, entry.employee_name)"></p-button>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="6" class="text-center p-4">
                                <p>No work hours found. Try adjusting your filters.</p>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-card>
        </ng-container>

    </div>
    <p-dialog [(visible)]="displayDialog" [header]="isEdit ? 'Edit Work Hours' : 'Log Work Hours'" [modal]="true"
        [draggable]="false" [resizable]="false" [style]="{width: '450px'}"
        [breakpoints]="{'960px': '75vw', '640px': '90vw'}" appendTo="body" *ngIf="isUser || isAdmin"
        styleClass="custom-dialog">

        <div class="dialog-content">
            <div class="dialog-field" *ngIf="isAdmin && !isEdit">
                <label class="font-bold text-sm text-700">
                    Employee <span class="text-red-500">*</span>
                </label>
                <p-select [options]="employees" [(ngModel)]="currentEntry.employeeId" optionLabel="name"
                    optionValue="id" placeholder="Select an Employee" [filter]="true" filterBy="name"
                    styleClass="w-full dialog-input" appendTo="body">
                </p-select>
            </div>

            <div class="dialog-field" *ngIf="isAdmin && isEdit">
                <label class="font-bold text-sm text-700">Editing for Employee</label>
                <input pInputText [value]="currentEntry.employeeName || currentEntry.employeeId" [disabled]="true"
                    class="w-full opacity-70" style="background: #f4f4f4;" />
            </div>

            <div class="dialog-field">
                <label for="workDate" class="font-bold text-sm text-700">
                    Work Date <span class="text-red-500">*</span>
                </label>
                <p-datepicker id="workDate" [(ngModel)]="currentEntry.workDate" dateFormat="yy-mm-dd" [showIcon]="true"
                    appendTo="body" styleClass="dialog-input" inputStyleClass="w-full">
                </p-datepicker>
            </div>

            <div class="dialog-field">
                <label for="hours" class="font-bold text-sm text-700">
                    Hours Worked <span class="text-red-500">*</span>
                </label>
                <p-inputNumber id="hours" [(ngModel)]="currentEntry.hours" mode="decimal" [minFractionDigits]="1"
                    [min]="0.5" [max]="8" styleClass="dialog-input" inputStyleClass="w-full" placeholder="e.g., 8.5"
                    [showButtons]="true">
                </p-inputNumber>
            </div>

            <div class="dialog-field">
                <label for="description" class="font-bold text-sm text-700">
                    Description (Optional)
                </label>
                <textarea pInputTextarea id="description" [(ngModel)]="currentEntry.description" rows="4"
                    class="dialog-textarea" placeholder="Enter what tasks you worked on...">
            </textarea>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <div class="flex justify-content-end gap-2 pt-3 border-top-1 surface-border">
                <p-button label="Cancel" icon="pi pi-times" [text]="true" severity="secondary"
                    (onClick)="hideDialog()"></p-button>
                <p-button [label]="isEdit ? 'Update' : 'Save'" icon="pi pi-check" (onClick)="saveWorkEntry()"
                    styleClass="px-4"></p-button>
            </div>
        </ng-template>
    </p-dialog>
</div>


<router-outlet></router-outlet>